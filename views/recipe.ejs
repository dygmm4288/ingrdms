<html>
    <head>
        <meta charset = "utf-8" />
        <meta name = "viewport" content = "user-scalable=no, initial-scale = 1.0, width = device-width, minimum-scale = 1.0, maximum-scale = 1.0"/>
        <link rel="stylesheet" type="text/css" href="/css/index.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script> 
        <title>Recipe Page</title>
    </head>
    <body>
        <div class = "app">
            <header id = "main_header">
                <aside id="user_menu"></aside>
                <h1>Recommend</h1>
                <button id="login_btn">로그인</button>
            </header>
            <div class = "content">
              <ul class="channel_list">

              </ul>
            </div>
            <nav id = "main_footer">
                <input type="button" id="back"/>
                <input type="button" id="reload"/>
            </nav>
        </div>
        <script>
          $(document).ready(() => {              
              if(`<%= way%>` === 'content'){
                $.ajax({
                url: "/process_recommend", // 클라이언트가 요청을 보낼 서버의 URL 주소
                type: "GET",
                data: {way:'content'},                             // HTTP 요청 방식(GET, POST)
                dataType: "json",                        // 서버에서 보내줄 데이터의 타입
                success: function(data){
                console.log(data);
                for(var i = 0;i<data.length;i++)
                {
                let recipe_id = data[i].recipe_id;
                let recipe_name =data[i].recipe_name;
                let time = data[i].time;
                let amount = data[i].amount;
                let level =data[i].level;
                let img = data[i].img_url;
                $('.channel_list').append(`
                <li class = "recipe_item">
                    <div class = "thumb">
                    <img src = "${img}"
                    style = "max-width: 100%;height:auto"/>
                    </div>
                    <strong class = "title">
                    ${recipe_name}.<br>
                    ${time} ${level}
                    </strong>
                </li>`)
                } 
            $('li').bind('click',function(e){
            new Promise((res,rej)=>{
              let result = confirm('이 레시피를 선택하시겠습니까?');
              if(result) {
                res(e.currentTarget.id);
              }
              else rej();
            }).then((recipeid)=>{
              const user_id = 'dygmm4288';
              $.ajax({
              url: "/setRecipe", // 클라이언트가 요청을 보낼 서버의 URL 주소
              data: { user_id: user_id,recipe_id: recipeid },                // HTTP 요청과 함께 서버로 보낼 데이터
              type: "GET",                             // HTTP 요청 방식(GET, POST)
              dataType: "json",
              success: function(data){
              if(data === true){
                alert('선택이 완료되었습니다.');
              }
              else{
                alert('선택이 완료되었습니다.(fail)');
              }
              }
            });
            })
            })
        },
        error: function(xhr,status,errorThrown){
          console.log('$.ajax Error'+errorThrown,status);
        }
        }).always((xhr,status)=>{console.log(`Recommand status is : ${status}`);})
              } 
              else {
                $.ajax({
                    url: "/process_recommend", // 클라이언트가 요청을 보낼 서버의 URL 주소
                    type: "GET",
                    data: {way:'ubcf'},                             // HTTP 요청 방식(GET, POST)
                    dataType: "json",                        // 서버에서 보내줄 데이터의 타입
                    success: function(data){
                console.log(data);
                for(var i = 0;i<data.length;i++)
                {
                let recipe_id = data[i].recipe_id;
                let recipe_name =data[i].recipe_name;
                let time = data[i].time;
                let amount = data[i].amount;
                let level =data[i].level;
                let img = data[i].img_url;
                $('.channel_list').append(`
                <li class = "recipe_item">
                    <div class = "thumb">
                    <img src = "${img}"
                    style = "max-width: 100%;height:auto"/>
                    </div>
                    <strong class = "title">
                    ${recipe_name}.<br>
                    ${time} ${level}
                    </strong>
                </li>`)
                } 
            $('li').bind('click',function(e){
            new Promise((res,rej)=>{
              let result = confirm('이 레시피를 선택하시겠습니까?');
              if(result) {
                res(e.currentTarget.id);
              }
              else rej();
            }).then((recipeid)=>{
              const user_id = 'dygmm4288';
              $.ajax({
              url: "/setRecipe", // 클라이언트가 요청을 보낼 서버의 URL 주소
              data: { user_id: user_id,recipe_id: recipeid },                // HTTP 요청과 함께 서버로 보낼 데이터
              type: "GET",                             // HTTP 요청 방식(GET, POST)
              dataType: "json",
              success: function(data){
              if(data === true){
                alert('선택이 완료되었습니다.');
              }
              else{
                alert('선택이 완료되었습니다.(fail)');
              }
              }
            });
            }).catch(() => {
                console.log('음 아무것도 선택 안함');
            })
            })
        }
                })
              } 
                
              /* 버튼 */
                $('.service_btn').click((handler) => {
                    var target =  handler.currentTarget.value;
                    if(target[0] === '냉') {
                        location.href = '/refrigerator';
                    }
                    else {
                        location.href = '/recipe';
                    }
                });
                $('#reload').click(() => {
                    location.reload();
                });
                $('#user_menu').click(() => {
                 location.href = '/main';
                }); 
                /* 로그인 관련 */
            /* 로그인 ajax */
            $.ajax({
                url: '/is_login',
                type: 'get',
                datatype: 'json',
                success: function(flag) {
                    if(flag) {
                        $('#login_btn').text('로그아웃');
                    }
                }
            })
            /* 로그인 로그아웃 버튼 변경 */
            $('#login_btn').click(function() {
                if($(this).text() === '로그인') {
                    location.href = '/login';
                }
                else {
                    location.href = '/logout';
                }
                
            })
            })
       
        </script>
    </body>
</html>